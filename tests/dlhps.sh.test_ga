#!/bin/bash
#COBALT -A datascience
#COBALT -q debug-cache-quad
#COBALT -n 4
#COBALT -t 30
#COBALT --attrs

source ~/.bash_profile
source activate dl-hps

JOBNAME=test
WORKFLOWNAME=test
WALLMINUTES=28
MAXEVALS=100000
NUM_WORKERS=$(( 16*($COBALT_JOBSIZE-1) ))
BENCHMARK="dummy1.three_hump_camel"
SEARCH_APP_PATH=~/workflows/deephyper/search/ga.py

balsam rm apps --all --force
balsam rm jobs --all --force
balsam app --name search --desc 'run GA search' --executable $SEARCH_APP_PATH

ARGS="--max-evals $MAXEVALS --benchmark $BENCHMARK --num-workers $NUM_WORKERS --evaluator balsam"

balsam job --name $JOBNAME --workflow $WORKFLOWNAME --application search --wall-minutes $WALLMINUTES  --num-nodes 1 --ranks-per-node 1 --args "$ARGS" --yes --threads-per-rank 64 --threads-per-core 1

balsam dbserver --stop
balsam dbserver --reset ~/hpc-edge-service/default_balsamdb
balsam dbserver
sleep 1
balsam launcher --wf-name $WORKFLOWNAME --max-ranks-per-node 16
